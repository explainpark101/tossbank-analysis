# 토스뱅크 거래내역 분석 API

토스뱅크 거래내역 Excel 파일을 업로드하고 분석하는 FastAPI 애플리케이션입니다.

## 기능

- 암호화된 Excel 파일 업로드 및 복호화
- 입금 거래만 필터링
- 적요 정리 및 중복 제거
- **동적 라벨 매핑**: 사용자가 직접 금액과 라벨을 설정 가능
- 기본 분류: 술안먹 (15,000원), 술먹음 (18,000원)
- JSON 형태로 결과 반환

## 설치 및 실행

### 1. 의존성 설치
```bash
uv sync
```

### 2. 서버 실행
```bash
uvicorn app:app --reload --host 0.0.0.0 --port 8000
```

### 3. 웹 인터페이스 접속
브라우저에서 `http://localhost:8000`에 접속하여 웹 인터페이스를 사용할 수 있습니다.

### 4. API 문서 확인
브라우저에서 `http://localhost:8000/docs`에 접속하여 Swagger UI를 확인할 수 있습니다.

## 웹 인터페이스

### 메인 페이지 (`/`)
- 파일 업로드 폼이 있는 사용자 친화적인 웹 인터페이스
- 드래그 앤 드롭으로 파일 선택 가능
- **동적 라벨 매핑 설정**: 금액과 라벨을 자유롭게 추가/제거 가능
- **고급 필터링 및 검색 기능**:
  - 구분별 필터링 (드롭다운)
  - 입금자명 실시간 검색
  - 체크박스로 행 선택 및 회색 처리
  - 전체 선택/해제 기능
  - 필터 초기화 기능
- **데이터 자동 저장 및 복원**:
  - 마지막 분석 결과 자동 저장 (localStorage)
  - 페이지 로드 시 마지막 데이터 자동 표시
  - 비밀번호 및 라벨 매핑 설정 복원
  - 분석일자 표시 및 관리
  - **체크박스 상태 저장**: 선택된 행 상태도 함께 저장
- **파일 다운로드 기능**:
  - CSV, Excel(XLSX), JSON 형식으로 다운로드
  - 전체/선택된 행/표시된 행만 다운로드 옵션
  - 자동 파일명 생성 (날짜/시간 포함)
  - 한글 인코딩 지원 (CSV UTF-8 BOM)
- 실시간 결과 표시 및 테이블 형태로 데이터 확인
- 반응형 디자인으로 모바일에서도 사용 가능

## API 엔드포인트

### 1. 루트 엔드포인트
- **GET** `/`
- 웹 인터페이스 (HTML 페이지) 반환

### 2. 거래내역 분석
- **POST** `/process-transaction-data`
- 토스뱅크 거래내역 Excel 파일을 업로드하고 분석

#### 요청 파라미터
- `file`: 토스뱅크 거래내역.xlsx 파일 (multipart/form-data)
- `password`: Excel 파일의 비밀번호 (form data)
- `label_mappings`: 라벨 매핑 JSON 문자열 (선택사항)
  - 형식: `[{"value": 15000, "label": "술안먹"}, {"value": 18000, "label": "술먹음"}]`
  - 비어있으면 기본값 사용

#### 응답 예시
```json
{
  "success": true,
  "message": "데이터 처리가 완료되었습니다.",
  "data": [
    {
      "입금자": "김철수",
      "입금액": 15000,
      "구분": "술안먹"
    },
    {
      "입금자": "이영희",
      "입금액": 18000,
      "구분": "술먹음"
    }
  ],
  "total_records": 2
}
```

### 3. 헬스 체크
- **GET** `/health`
- 서버 상태 확인

## 사용 예시

### cURL을 사용한 요청
```bash
curl -X POST "http://localhost:8000/process-transaction-data" \
  -H "Content-Type: multipart/form-data" \
  -F "file=@토스뱅크_거래내역.xlsx" \
  -F "password=yourpasswd"
```

### Python을 사용한 요청
```python
import requests

url = "http://localhost:8000/process-transaction-data"
files = {"file": open("토스뱅크_거래내역.xlsx", "rb")}
data = {"password": "yourpasswd"}

response = requests.post(url, files=files, data=data)
result = response.json()
print(result)
```

## 데이터 처리 과정

1. **파일 복호화**: 제공된 비밀번호로 Excel 파일 복호화
2. **데이터 필터링**: "거래 유형"이 "입금"인 데이터만 추출
3. **적요 정리**:
   - 괄호 안의 내용 제거
   - 공백 제거
   - 학번 패턴 정리 (예: "21학번김철수" → "21김철수")
4. **그룹화**: 적요별로 거래금액 합계
5. **중복 제거**: 동일한 적요의 중복 제거
6. **분류**:
   - 사용자 정의 라벨 매핑이 있으면 해당 매핑 사용
   - 없으면 기본값: 15,000원 → "술안먹", 18,000원 → "술먹음"
   - 매핑되지 않은 금액 → "기타"로 분류 후 제외
7. **정렬**: 구분, 적요 순으로 정렬

## 라벨 매핑 사용법

### 웹 인터페이스에서
1. "라벨 매핑 설정" 섹션에서 "+ 라벨 추가" 버튼 클릭
2. 금액과 라벨명을 입력
3. 필요에 따라 여러 개의 매핑 추가 가능
4. "×" 버튼으로 불필요한 매핑 제거 가능

### API에서
```json
{
  "label_mappings": [
    {"value": 15000, "label": "술안먹"},
    {"value": 18000, "label": "술먹음"},
    {"value": 20000, "label": "특별모임"}
  ]
}
```

## 결과 필터링 및 검색 기능

### 필터링 옵션
- **구분별 필터링**: 드롭다운에서 특정 구분만 표시
- **입금자명 검색**: 실시간으로 입금자명 검색
- **체크박스 선택**: 개별 행을 선택하여 회색 처리
- **전체 선택/해제**: 모든 표시된 행을 한 번에 선택/해제
- **필터 초기화**: 모든 필터와 선택을 초기화

### 사용법
1. **검색**: 검색창에 입금자명의 일부를 입력
2. **구분 필터**: 드롭다운에서 원하는 구분 선택
3. **행 선택**: 체크박스를 클릭하여 해당 행을 회색 처리
4. **일괄 선택**: "전체 선택" 버튼으로 모든 표시된 행 선택
5. **초기화**: "필터 초기화" 버튼으로 모든 설정 초기화

## 데이터 자동 저장 및 복원

### 자동 저장 기능
- **분석 완료 시 자동 저장**: 비밀번호, 라벨 매핑, 분석 결과가 localStorage에 자동 저장
- **브라우저 종료 후에도 유지**: 페이지를 새로고침하거나 다시 방문해도 데이터 유지
- **분석일자 기록**: 언제 분석했는지 정확한 날짜와 시간 표시

### 자동 복원 기능
- **페이지 로드 시 자동 표시**: 마지막 분석 결과가 있으면 자동으로 표시
- **폼 데이터 복원**: 비밀번호와 라벨 매핑 설정이 자동으로 복원
- **즉시 사용 가능**: 파일만 다시 업로드하면 바로 분석 가능

### 데이터 관리
- **불러오기**: "불러오기" 버튼으로 저장된 데이터를 다시 표시
- **삭제**: "삭제" 버튼으로 저장된 데이터를 완전히 제거
- **확인 대화상자**: 실수로 삭제하지 않도록 확인 절차

### 저장되는 데이터
```json
{
  "password": "yourpasswd",
  "labelMappings": [
    {"value": 15000, "label": "술안먹"},
    {"value": 18000, "label": "술먹음"}
  ],
  "resultData": [...],
  "checkedItems": [0, 2, 5],
  "analysisDate": "2024-01-15T14:30:00.000Z",
  "timestamp": 1705327800000
}
```

## 파일 다운로드 기능

### 지원 형식
- **CSV**: 쉼표로 구분된 텍스트 파일 (Excel에서 열기 가능)
- **Excel (XLSX)**: Microsoft Excel 형식
- **JSON**: JavaScript Object Notation 형식

### 다운로드 옵션
1. **전체 데이터**: 모든 분석 결과 다운로드
2. **선택된 행만**: 체크박스로 선택한 행만 다운로드
3. **현재 표시된 행만**: 필터링된 결과만 다운로드

### 사용 방법
1. **다운로드 버튼 클릭**: "💾 다운로드" 버튼 클릭
2. **다운로드 범위 선택**: 전체/선택된 행/표시된 행 중 선택
3. **파일 형식 선택**: CSV/Excel/JSON 중 선택
4. **자동 다운로드**: 선택 즉시 파일 다운로드 시작

### 파일명 규칙
```
토스뱅크_거래내역_분석_YYYYMMDD_HHMMSS.확장자
예: 토스뱅크_거래내역_분석_20240115_143022.csv
```

### 특별 기능
- **한글 지원**: CSV 파일에 UTF-8 BOM 추가로 한글 깨짐 방지
- **Excel 호환**: XLSX 형식으로 Excel에서 바로 열기 가능
- **구조화된 JSON**: 프로그래밍에서 쉽게 처리할 수 있는 JSON 형식
- **실시간 정보**: 다운로드할 데이터 건수 실시간 표시

## 에러 처리

- 잘못된 파일 형식: 400 Bad Request
- 잘못된 비밀번호: 400 Bad Request
- 파일 처리 오류: 400 Bad Request
- 서버 오류: 500 Internal Server Error
